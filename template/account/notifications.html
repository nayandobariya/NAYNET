{% extends 'base.html' %}
{% load static %}
{% block content %}

<!-- Include Social Header -->
{% include 'account/social_header.html' %}

<div class="social-container">
    <div class="social-main-content">
        <div class="notifications-page">
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-bell"></i>
                    Notifications
                </h1>
                <div class="page-actions">
                    <button class="btn-outline" onclick="markAllAsRead()">
                        Mark all as read
                    </button>
                </div>
            </div>

            <div class="notifications-list" id="notifications-list">
                <!-- Notifications will be loaded dynamically -->
                <div class="loading-spinner text-center p-5">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Loading notifications...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="social-sidebar">
        <div class="sidebar-card">
            <h4 class="sidebar-title">Notification Settings</h4>
            <p class="text-muted small">Manage how you receive updates about your network.</p>
            <a href="{% url 'account:settings' %}" class="btn-link">Edit Settings</a>
        </div>
    </div>
</div>

<template id="notification-template">
    <div class="notification-item" data-id="">
        <div class="notification-icon">
            <i class="fas"></i>
        </div>
        <div class="notification-content">
            <p class="notification-text"></p>
            <span class="notification-time"></span>
        </div>
        <div class="notification-actions">
            <button class="btn-dot-menu"><i class="fas fa-ellipsis-h"></i></button>
        </div>
    </div>
</template>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadNotifications();
    });

    function loadNotifications() {
        fetch('{% url "account:get_notifications" %}', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('notifications-list');
                list.innerHTML = '';

                if (data.notifications && data.notifications.length > 0) {
                    data.notifications.forEach(notif => {
                        const html = createNotificationHTML(notif);
                        list.insertAdjacentHTML('beforeend', html);
                    });
                } else {
                    list.innerHTML = `
                <div class="empty-state text-center p-5">
                    <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                    <h3>No notifications yet</h3>
                    <p class="text-muted">We'll let you know when something happens in your network.</p>
                </div>
            `;
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function createNotificationHTML(notif) {
        let iconClass = 'fa-bell';
        let bgClass = '';

        if (notif.type === 'connection_request') {
            iconClass = 'fa-user-plus';
            bgClass = 'bg-primary-light text-primary';
        } else if (notif.type === 'message') {
            iconClass = 'fa-envelope';
            bgClass = 'bg-success-light text-success';
        } else if (notif.type === 'like') {
            iconClass = 'fa-thumbs-up';
            bgClass = 'bg-info-light text-info';
        } else if (notif.type === 'comment') {
            iconClass = 'fa-comment';
            bgClass = 'bg-warning-light text-warning';
        }

        const template = document.getElementById('notification-template');
        const clone = template.content.cloneNode(true);
        const item = clone.querySelector('.notification-item');

        item.setAttribute('data-id', notif.id);
        if (!notif.is_read) item.classList.add('unread');

        item.querySelector('.notification-icon i').className = `fas ${iconClass}`;
        // Add specific click handler
        item.addEventListener('click', () => {
            window.location.href = notif.link;
        });

        item.querySelector('.notification-text').innerHTML = notif.message; // Use innerHTML for potential bolding
        item.querySelector('.notification-time').textContent = notif.created_at;

        return item.outerHTML;
    }

    function markAllAsRead() {
        // Implementation for marking all as read
        // For now, just reload to clear badges visually if backend supported it
        console.log('Marking all as read...');
    }
</script>

{% endblock %}